# PDFマーカーからのテキスト情報抽出

## 環境

Pythonのプロジェクトマネージャー [uv](https://docs.astral.sh/uv/) を使用。

## 手順




### 1. [extract.py](../../extract.py) で注釈情報をCSVに出力

#### コマンド

```
uv run .\extract.py [対象PDFのパス | PDFが置かれているディレクトリのパス]
```

一段組の場合はコマンド末尾に引数 `1` を指定すること。

```
uv run .\extract.py [対象PDFのパス | PDFが置かれているディレクトリのパス] 1
```

#### 出力ファイル

`[元ファイル名]_step1.csv`

- 注釈情報の抽出結果
- 各フィールドの定義は [HighlightEntry](../../entry.py) データクラスを参照

`[元ファイル名]_step1_checklist.txt`

- このファイルは出力されないこともある
- PyMuPDFの `Page.get_text()` は、マーカーの矩形が少しでも別の行のフォントbboxに重なるとその行の文字列も取り出してしまう。
    - PDFの行間が詰まっている場合に発生しやすい
    - 上下行に刺さるような字形が使われているときに発生するかもしれない
- [`extract.py`](../../extract.py) では矩形の垂直方向の重なり具合で判定しているが、目で確認するために出力するのがこのファイル

#### 作業内容：`Name` 列をPDFと照合する


- もしチェックリストファイルが出力されていたら、意図した通りに文字列抽出できているか確認する
    - 意図しない形で抽出されていたら、CSVファイルの `Text` 列を編集する
        - 座標列はいじらなくてOK
        - 座標を基準にすると余計な文字が拾われてしまうことには変わりないが良しとする。座標はリンク挿入のためにしか使わないうえに、将来的に重要なのは対象文字列の情報。
- チェック事項1：「連続するマーカーには同じ名前がついているか」
    - `Name` 列でグループ化したときに `Text` 列をつなげて読むとPDFの通りになるようにする
    - 異なるマーカーに同じ名前が振られていた場合、別の文字列で上書きする
        - 新たにつける名前は、直前・直後の文字列と同じでなければ何でもOK。以降の処理では `Name` 列を上から順に連続するものをグループ化するため
    - もし順番が入れ替わるなどしていた場合はCSVの行を移動させてもOK
- チェック事項2：「不要な文字が拾われていないか」
    - まれに、柱の文字列などをエントリとして拾ってしまうことがある。そうしたエントリが見つかった場合は `Name` 列を空にすれば以降の処理ではスキップされる




### 2. [jsonfy.py](../../jsonfy.py) でCSVをJSON化

#### コマンド

```
uv run .\jsonfy.py [対象PDFのパス | PDFが置かれているディレクトリのパス]
```

#### 出力ファイル

`[元ファイル名]_step2_kiri.csv`

- 桐データベースに読み込ませるためのCSV

`[元ファイル名]_step3.json`

- 各フィールドの定義は [JsonEntry](../../entry.py) データクラスを参照
- マーカー対象の文字列とその矩形情報をまとめたファイル。このファイルが諸々の基盤となる
    - 文字列は意味をもつまとまりを単位としてエントリ化している
    - PDFが挿入した余計な空白も除去済み
- このファイルを手で編集する

#### 作業内容：JSONの `Href` フィールドを埋めていく

- 出力されたCSVの4列目を編集して桐データベースに読み込む
    - これで各エントリに対して一意のIDが発行される
- 発行されたIDを `Href` フィールドに入れていく



### 3. [rirify.py](../../rirify.py) で外部ツール形式に変換

#### コマンド

```
uv run .\rirify [対象PDFのパス | PDFが置かれているディレクトリのパス]
```


#### 出力ファイル

`[元ファイル名]_step3_riri.txt`

- 特殊フォーマットのTSV
- JSONで、同一エントリ内で `Location` の `PageIndex` が複数種ある場合、すなわちマーカーがページで泣き別れになっている場合は2列目が `0` になる


#### 作業内容：専用ツールでの操作

将来的には、[linkify.py](../../linkify.py) でPDFにリンクを直に埋め込むことも計画中。

